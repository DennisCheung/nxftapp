<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <link rel="stylesheet" type="text/css" href="../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../css/font/iconfont.css" />
    <link rel="stylesheet" type="text/css" href="../css/sendDetailB.css" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>待送达详情</title>
</head>
<body>
  <!-- 到户 -->
    <header class="aui-bar aui-bar-nav" id="header">
        <a class="aui-pull-left aui-btn" tapmode onclick="closeNow();">
            <span class="aui-iconfont aui-icon-left"></span>
        </a>
        <div class="aui-title">待送达详情</div>
    </header>
    <!-- 带联系人及电话 -->

    <!-- 不带联系人及电话 -->
    <div class="aui-content my-padding">

        <div class="ant-steps">
            <div class="ant-steps-fetch">
                <i></i>
            </div>
            <div class="ant-steps-send">
                <div class="ant-steps-head">
                    <div class="ant-steps-head-inner ant-steps-head-fetch">
                        <span></span>
                    </div>
                </div>
                <div class="ant-steps-main">
                    <div class="aui-text-default line-h" id="kitchenTeamName"></div>
                    <div class="gray line-h" id="kitchenTeamAddress"></div>
                </div>
            </div>
        </div>
        <div class="ant-steps">
            <div class="ant-steps-send">
                <div class="ant-steps-head">
                    <div class="ant-steps-head-inner ant-steps-head-send">
                        <span class="send"></span>
                    </div>
                </div>
                <div class="ant-steps-main">
                    <div class="aui-text-default line-h" id="deliveSiteName"></div>
                    <div class="gray line-h" id="deliveAddr"></div>
                </div>
            </div>
        </div>
        <!-- 线条 -->
        <div class="line">
            <img src="../image/my/line.png" class="line-img">
        </div>
    </div>
    <!-- 配单详情 -->
    <div class="aui-content aui-margin-t-15" style="background:#ffffff;">
        <!-- 配送单号 -->
        <div class="aui-info aui-margin-t-10 aui-padded-l-10 aui-padded-r-10">
            <div class="aui-info-item">
                <span class="aui-padded-r-5">配送单号</span>
                <span class="aui-text-default" id="deliveNoteId"></span>
            </div>
            <div class="aui-info-item">
                <i class="iconfont icon-motuoche-copy aui-text-green aui-font-size-20"></i>
                <span class="aui-margin-l-5 aui-text-success" id="deliveTypeName"></span><!--到户-->
            </div>
        </div>
        <hr class="my-hr">
        <!-- 订单列表 -->
        <div class="aui-content my-list">
            <ul class="aui-list aui-list-in" id="mealNum">


            </ul>
        </div>
        <!-- 总计 -->
        <div class="footer aui-content aui-padded-r-10 aui-padded-t-10 aui-padded-b-10">
            <span class="aui-text-transition aui-pull-right aui-font-size-16">总计<i class="aui-text-blue" id="unCompleteQuantity"></i>份</span>
        </div>
    </div>
    <!-- 订单详情 -->
    <div class="detail-word aui-content aui-text-gray aui-padded-b-10 aui-padded-10" style="text-align: center">
        ———— 订单详情 ————
    </div>
    <!-- 联系人及饭盒编号 -->
    <!-- <div class="aui-content aui-margin-b-15 meal-box">
        <ul class="aui-list aui-list-in">
            <li class="aui-list-item aui-padded-t-10 aui-padded-b-10">
                <div class="aui-list-item-inner">
                  <div class="aui-list-item-title">
                      <span>陈金妹</span>
                      <span class="aui-text-gray aui-padded-l-10">餐盒编号：06</span>
                  </div>
                    <div class="aui-list-item-right aui-text-default">冬菇云耳鸡腿肉饭</div>
                </div>
            </li>
            <li class="aui-list-item aui-padded-t-10 aui-padded-b-10 my-list-item">
                <div class="chat-address aui-padded-t-5 aui-padded-b-5">
                  <div class="l">
                    <i></i>
                    <span class="aui-padded-l-5">联系电话</span>
                    <span class="aui-padded-l-5"> 020****3739</span>
                  </div>
                    <input class="call aui-margin-r-5" type="button" value="联系">
                </div>
                <div class="chat-address aui-padded-t-5 aui-padded-b-5">
                  <div class="l">
                    <i></i>
                    <span class="aui-padded-l-5">配送地址 </span>
                    <span class="aui-padded-l-5">东丽园十四栋302房</span>
                  </div>
                  <input class="send aui-margin-r-5" type="button" value="送达">
                </div>
            </li>
        </ul>
    </div> -->
    <!-- <div class="aui-content aui-margin-b-15 meal-box">
        <ul class="aui-list aui-list-in">
            <li class="aui-list-item aui-padded-t-10 aui-padded-b-10">
                <div class="aui-list-item-inner">
                  <div class="aui-list-item-title">
                      <span>陈金妹</span>
                      <span class="aui-text-gray aui-padded-l-10">餐盒编号：06</span>
                  </div>
                    <div class="aui-list-item-right aui-text-default">冬菇云耳鸡腿肉饭</div>
                </div>
            </li>
            <li class="aui-list-item aui-padded-t-10 aui-padded-b-10 my-list-item">
                <div class="chat-address aui-padded-t-5 aui-padded-b-5">
                  <div class="l">
                    <i></i>
                    <span class="aui-padded-l-5">联系电话</span>
                    <span class="aui-padded-l-5"> 020****3739</span>
                  </div>
                    <input class="call aui-margin-r-5" type="button" value="联系">
                </div>
                <div class="chat-address aui-padded-t-5 aui-padded-b-5">
                  <div class="l">
                    <i></i>
                    <span class="aui-padded-l-5">配送地址 </span>
                    <span class="aui-padded-l-5">东丽园十四栋302房</span>
                  </div>
                  <input class="send aui-margin-r-5" type="button" value="送达">
                </div>
            </li>
        </ul>
    </div> -->
    <div id="box">

    </div>
    <div class="aui-padding-t-10 aui-text-gray aui-margin-b-10" style="text-align:center;">
      没有更多了
    </div>
<script src="../script/api.js"></script>
<script src="data:application/octet-stream;base64,ZnVuY3Rpb24gZm9ybWF0UGhvbmUocGhvbmUpew0KICB2YXIgcGhvbmU9cGhvbmV8fCIiOw0KICBpZighcGhvbmUpcmV0dXJuOw0KICBwaG9uZT1waG9uZS50b1N0cmluZygpOw0KICB2YXIgc3RhcnQ9cGhvbmUuc3Vic3RyKDAsNCk7DQogIHZhciBlbmQ9cGhvbmUuc3Vic3RyKC00KTsNCiAgcmV0dXJuIHN0YXJ0KyIqKioqIitlbmQ7DQp9DQo="></script>
<script>
var url = $api.getStorage("url");
var dialogBox;
apiready=function(){
  dialogBox = api.require('dialogBox');
  var header=document.getElementById("header");
  $api.fixStatusBar(header);
  requestData();
}
//请求数据
function requestData(){
  $api.html($api.byId("mealNum"),"");
  $api.html($api.byId("box"),"");

  api.ajax({
      url: url + '/cors/findDeliveNoteCDetail?deliveNoteId=' +api.pageParam.id ,
      method: 'get',
      dataType: 'json'
  }, function(ret, err) {
      $api.text($api.byId('kitchenTeamName'),ret.kitchenTeamName);
      $api.text($api.byId('kitchenTeamAddress'),ret.kitchenTeamAddress);
      $api.text($api.byId('deliveAddr'),ret.deliveAddr);
      $api.text($api.byId('deliveSiteName'),ret.deliveSiteName);
      $api.text($api.byId('deliveNoteId'),ret.deliveNoteId);
      $api.text($api.byId('deliveTypeName'),ret.deliveTypeName);
      $api.text($api.byId('unCompleteQuantity'),ret.orderList.length);
      // $api.text($api.byId('week'),ret.week);
      // $api.text($api.byId('mealDate'),formatDate(ret.mealDate));
      // $api.text($api.byId('mealTypeName'),ret.mealTypeName.substring(0,1));
      //订单菜单数量
      var mealHtml='<li class="aui-list-header"><div><span class="aui-text-default"><i id="mealDate">'+
      formatDate(ret.mealDate)+'</i><i id="week">'+
      ret.week+'</i></span><span class="circle aui-margin-l-5"><i class="num aui-text-blue" id="mealTypeName">'+
      ret.mealTypeName.substring(0,1)+'</i></span></div></li>';

      for(var j=0;j<ret.mealNum.length;j++){
        mealHtml +='<li class="aui-list-item"><div class="aui-list-item-inner"><div class="aui-list-item-title aui-text-blue">'+
        ret.mealNum[j].mealName+//菜名
        '</div><div class="aui-list-item-right aui-text-blue aui-font-size-16">×'+
        ret.mealNum[j].quantity+//数量
        '</div> </div></li>';
      }

      //订单餐盒
      var html="";
      for(var i=0;i<ret.orderList.length;i++){
        html +='<div class="aui-content aui-margin-b-15 meal-box"><ul class="aui-list aui-list-in"><li class="aui-list-item aui-padded-t-10 aui-padded-b-10"><div class="aui-list-item-inner"><div class="aui-list-item-title"><span>'+
                ret.orderList[i].subjectName+
                '</span><span class="aui-text-gray aui-padded-l-10">餐盒编号：'+
                ret.orderList[i].lunchBoxNo+'</span></div><div class="aui-list-item-right aui-text-default">'+
                //餐别
                ret.orderList[i].mealName+
                '</div></div></li><li class="aui-list-item aui-padded-t-10 aui-padded-b-10 my-list-item"><div class="chat-address aui-padded-t-5 aui-padded-b-5"><div class="l"><i></i><span class="aui-padded-l-5">联系电话</span><span class="aui-padded-l-5">'+
                formatPhone(ret.orderList[i].contactPhone)+
                '</span></div><input class="call aui-margin-r-5" type="button" value="联系" onclick=call('+
                '"callback"'+',"'+ret.orderList[i].address+'","'+ret.orderList[i].subjectName+'","'+ret.orderList[i].contactPhone+
                '")></div><div class="chat-address aui-padded-t-5 aui-padded-b-5"><div class="l"><i></i><span class="aui-padded-l-5">配送地址 </span><span class="aui-padded-l-5">'+
                ret.orderList[i].address+
                '</span></div><input class="send aui-margin-r-5" type="button" value="送达" tapmode onclick="send('+
                ret.orderList[i].orderId+')"/></div></li></ul></div>';
      }
      $api.append($api.byId("mealNum"), mealHtml);
      $api.append($api.byId("box"), html);
  });
}
//联系
function call(type,address,name,phone){
  dialogBox.alert({
    texts: {
        title: address,
        content: name+" "+formatPhone(phone),
        leftBtnTitle: '取消',
        rightBtnTitle: '呼叫'
    },
    styles: {
        bg: '#fff',
        w: 260,
        title: {
            marginT: 20,
            titleSize: 14,
            titleColor: '#000'
        },
        content: {
            color: '#000',
            size: 14
        },
        left: {
            marginB: 20,
            marginL: 30,
            h: 35,
            corner: 2,
            size: 12,
            color : "#666",
            bg : '#ccc'
        },
        right: {
            marginB: 20,
            h: 35,
            corner: 2,
            size: 12,
            color : "#0077f8",
            bg : '#ccc'
        }
      }
    }, function(ret) {
    if (ret.eventType == 'left') {
        var dialogBox = api.require('dialogBox');
        dialogBox.close({
            dialogName: 'alert'
        });
    }else{
      api.call({
        type: 'tel',
        number: ''+phone
      });
    }
  });
}
//送达按钮
function send(subjectId){
        dialogBox.alert({
          texts : {
              content : '是否确认送达？',
              leftBtnTitle : '取消',
              rightBtnTitle : '确认'
          },
          styles : {
              bg : '#fff',
              corner : 6,
              w : 260,
              content : {
                marginT : 40,
                marginB : 40,
                color : '#333',
                size : 16
              },
            left : {
                marginB : 20,
                marginL : 30,
                h : 35,
                corner : 2,
                color : "#666",
                bg : '#ccc',
                size : 12
            },
            right : {
                marginB : 20,
                h : 35,
                corner : 2,
                color : "#0077f8",
                bg : '#ccc',
                size : 12
            }
      },
        tapClose : false
    }, function(ret) {
        if (ret.eventType == 'left') {
            dialogBox.close({
                dialogName: 'alert'
            });
        }else{
          api.ajax({
                  url : url+'/cors/confirmDeliveDetail',
                  method : 'post',
                  dataType : 'json',
                  headers:{
                    "content-type": "application/json"
                  },
                  data : {
                      body:{
                        userId:$api.getStorage('userId'),
                        teamId:$api.getStorage('teamId'),
                        deliveNoteId:api.pageParam.id,
                        orderIds : [subjectId]
                      }
                  }
          },function(ret, err) {
            dialogBox.close({
                dialogName: 'alert'
            });
            requestData();
          });
        }
      });
}
function formatDate(d) {
  var now=new Date(d);
  var year=now.getFullYear();
  var month=now.getMonth()+1;
  var date=now.getDate();
  var hour=now.getHours();
  var minute=now.getMinutes();
  var second=now.getSeconds();
  return year+"-"+month+"-"+date;
}
//关闭窗口
function closeNow(){
  api.closeWin();
  api.sendEvent({
    name: 'myEvent',
    extra: {
        key1: 'value1',
        key2: 'value2'
    }
  });
}
    </script>
</body>
</html>
